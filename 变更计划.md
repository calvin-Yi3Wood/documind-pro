阶段 1：项目初始化 & 基础架构
阶段 2：类型系统 & Skills 架构
阶段 3：后端 API 层（Vercel Functions）
阶段 4：核心服务层重构
阶段 5：UI 组件迁移
阶段 6：安全性增强
阶段 7：存储层 & 用户系统
阶段 8：协同编辑基础
阶段 9：测试 & 文档

阶段 1：项目初始化 & 基础架构
提示词 1.1 - 创建新项目
我需要你帮我创建一个新的商业化项目，基于现有的 DocuMind AI 项目进行重构。

请执行以下任务：

1. 在 /home/user/ 目录下创建新项目 documind-pro
2. 使用 Next.js 14+ App Router 初始化项目（因为需要 API Routes 作为后端）
3. 配置 TypeScript 严格模式
4. 配置 Tailwind CSS
5. 配置 ESLint + Prettier
6. 创建以下目录结构：

documind-pro/
├── app/                    # Next.js App Router
│   ├── api/               # API Routes（后端）
│   ├── (auth)/            # 认证相关页面
│   └── (dashboard)/       # 主应用页面
├── components/            # UI 组件
│   ├── ui/               # 基础 UI 组件
│   └── features/         # 功能组件
├── skills/               # Skills 系统
│   ├── registry.ts       # Skill 注册表
│   └── [skill-name]/     # 各个 Skill
├── services/             # 业务服务层
├── lib/                  # 工具函数
├── types/                # TypeScript 类型
├── hooks/                # React Hooks
└── config/               # 配置文件

7. 配置环境变量模板 .env.example（包含 GEMINI_API_KEY, DEEPSEEK_API_KEY 等）
8. 配置 .gitignore

参考原项目位置：/home/user/documind-ai-agent

不要迁移任何业务代码，只做项目骨架搭建。

提示词 1.2 - 配置依赖
继续 documind-pro 项目的配置。

请安装以下依赖：

生产依赖：
- next-auth（认证）
- @supabase/supabase-js（数据库）
- zod（数据验证）
- dompurify + @types/dompurify（XSS 防护）
- nanoid（ID 生成）
- zustand（状态管理，比 Redux 轻量）
- react-hot-toast（通知）
- lucide-react（图标）

开发依赖：
- @types/node
- @types/react
- typescript
- eslint-config-next
- prettier
- prettier-plugin-tailwindcss

配置 tsconfig.json 的 paths 别名：
- @/* 指向根目录
- @/components/* 
- @/services/*
- @/skills/*
- @/lib/*
- @/types/*

不要写业务代码，只做依赖安装和配置。

阶段 2：类型系统 & Skills 架构
提示词 2.1 - 核心类型定义
为 documind-pro 项目创建核心类型系统。

参考原项目 /home/user/documind-ai-agent/types.ts，但需要重新设计以支持：
1. Skills 系统
2. 多用户
3. 协同编辑
4. 云存储

请在 types/ 目录下创建：

1. types/index.ts - 统一导出
2. types/user.ts - 用户相关类型
3. types/document.ts - 文档相关类型
4. types/skill.ts - Skill 系统类型
5. types/chat.ts - 聊天消息类型
6. types/api.ts - API 请求响应类型

关键类型设计要求：

Skill 类型需要包含：
- name: string（唯一标识）
- description: string（AI 用于匹配的描述）
- category: 'ai-chat' | 'image' | 'visualization' | 'document' | 'search'
- execute: 异步执行函数
- isAvailable: 可用性检查

Document 类型需要支持：
- 版本控制（version）
- 协作者列表（collaborators）
- 权限（permissions）
- 云端同步状态（syncStatus）

User 类型需要支持：
- 订阅等级（subscription）
- 使用配额（quota）

只创建类型定义，不写实现代码。

提示词 2.2 - Skills 系统架构
为 documind-pro 项目设计并实现 Skills 系统的核心架构。

参考 Claude Code 的 Skills 机制设计理念：
- Skills 是模型自主调用的，不是用户手动触发
- 启动时只加载元数据（name + description）
- 执行时才加载完整实现
- 每个 Skill 是独立模块

请创建以下文件：

1. skills/types.ts
   - SkillDefinition 接口
   - SkillContext 接口（包含 query, document, selection, history）
   - SkillResult 接口
   - SkillRegistry 类型

2. skills/registry.ts
   - 实现 Skill 注册表
   - 提供 register、get、list 方法
   - 提供 selectSkill 方法（根据用户意图匹配最佳 Skill）

3. skills/loader.ts
   - 实现 Skill 的懒加载机制
   - 只在需要时动态导入 Skill 实现

4. 创建示例 Skill 目录结构（不实现逻辑）：
   skills/
   ├── ai-chat/
   │   ├── index.ts        # Skill 定义
   │   └── manifest.json   # 元数据
   ├── image-generation/
   ├── visualization/
   ├── document-analysis/
   └── web-search/

每个 Skill 的 manifest.json 应包含：
- name
- description（给 AI 看的，用于决策）
- triggers（触发关键词）
- category
- requiredPermissions

只创建架构和接口，具体 Skill 实现留到后面阶段。

阶段 3：后端 API 层
提示词 3.1 - API 路由基础架构
为 documind-pro 项目创建后端 API 层架构。

使用 Next.js 14 App Router 的 Route Handlers。

请创建以下 API 结构：

app/api/
├── auth/
│   └── [...nextauth]/route.ts    # NextAuth 配置
├── ai/
│   ├── chat/route.ts             # AI 对话代理
│   ├── image/route.ts            # 图片生成代理
│   └── complete/route.ts         # 自动补全代理
├── skills/
│   ├── route.ts                  # 获取可用 Skills 列表
│   ├── [skillName]/route.ts      # 执行特定 Skill
│   └── select/route.ts           # AI 选择最佳 Skill
├── documents/
│   ├── route.ts                  # CRUD
│   └── [id]/route.ts             # 单文档操作
└── user/
    ├── profile/route.ts          # 用户信息
    └── quota/route.ts            # 使用配额

创建以下中间件和工具：

1. lib/api/middleware.ts
   - 认证中间件
   - 速率限制中间件
   - 错误处理包装器

2. lib/api/response.ts
   - 统一响应格式
   - 错误响应格式

3. lib/api/validation.ts
   - 使用 Zod 的请求验证工具

设计要点：
- 所有 AI API Key 只在服务端使用，绝不暴露给前端
- 统一错误处理
- 请求验证
- 响应格式标准化

只创建架构和空实现，具体逻辑留到后面。

提示词 3.2 - AI 代理服务实现
为 documind-pro 项目实现 AI 代理服务层。

这是最关键的安全层 —— 所有 AI 调用都通过后端代理。

参考原项目的 AI 服务实现：
- /home/user/documind-ai-agent/services/geminiService.ts
- /home/user/documind-ai-agent/services/deepseekService.ts

请实现：

1. services/ai/gemini.ts
   - 服务端 Gemini API 封装
   - 流式响应支持
   - 提示词模板管理（核心资产，只在服务端）

2. services/ai/deepseek.ts
   - 服务端 DeepSeek API 封装
   - 流式响应支持

3. services/ai/provider.ts
   - AI 提供商抽象接口
   - 统一的调用方式
   - 自动降级（Gemini 失败 → DeepSeek）

4. app/api/ai/chat/route.ts 完整实现
   - 接收前端请求
   - 验证用户身份
   - 检查使用配额
   - 调用 AI 服务
   - 返回流式响应

5. config/prompts.ts（服务端专用）
   - 系统提示词模板
   - 各种场景的提示词
   - 这些是核心资产，只在服务端存在

关键安全要求：
- API Key 从环境变量读取
- 提示词模板不暴露给前端
- 实现请求验证和配额检查

阶段 4：核心服务层重构
提示词 4.1 - 存储服务层
为 documind-pro 项目实现存储服务层。

设计支持多种存储后端的抽象层：

1. services/storage/interface.ts
   - StorageProvider 接口定义
   - 支持 CRUD 操作
   - 支持文件上传

2. services/storage/supabase.ts
   - Supabase 实现
   - 文档存储
   - 文件上传到 Supabase Storage

3. services/storage/local.ts
   - 本地存储实现（开发用）
   - 兼容原项目的 IndexedDB 逻辑

4. services/storage/index.ts
   - 根据环境自动选择存储后端
   - 开发环境用本地，生产用 Supabase

5. hooks/useStorage.ts
   - React Hook 封装
   - 自动同步状态
   - 乐观更新

参考原项目：
- /home/user/documind-ai-agent/services/storageService.ts
- /home/user/documind-ai-agent/services/indexedDBService.ts

但需要重新设计以支持：
- 云端存储
- 多用户隔离
- 版本控制
- 离线优先 + 云同步

提示词 4.2 - 搜索服务重构
为 documind-pro 项目重构搜索服务。

参考原项目：/home/user/documind-ai-agent/services/searchService.ts

关键改进：
1. 搜索 API Key 移到后端
2. 实现更好的降级策略
3. 结果缓存

请实现：

1. app/api/search/route.ts
   - 后端搜索代理
   - 隐藏真实 API Key

2. services/search/index.ts
   - 搜索服务客户端
   - 调用后端 API

3. services/search/providers/（服务端）
   - google.ts - Google Custom Search
   - duckduckgo.ts - DuckDuckGo
   - wikipedia.ts - Wikipedia

4. 实现搜索结果缓存
   - 相同查询 5 分钟内返回缓存
   - 减少 API 调用成本

阶段 5：UI 组件迁移
提示词 5.1 - 基础 UI 组件
为 documind-pro 项目创建基础 UI 组件库。

在 components/ui/ 目录下创建：

1. Button.tsx - 按钮组件（多种变体）
2. Input.tsx - 输入框
3. Modal.tsx - 模态框
4. Toast.tsx - 通知提示（参考原项目 Toast.tsx）
5. Dropdown.tsx - 下拉菜单
6. Tooltip.tsx - 工具提示
7. Spinner.tsx - 加载动画
8. Card.tsx - 卡片容器
9. Tabs.tsx - 标签页

设计要求：
- 使用 Tailwind CSS
- 支持深色/浅色主题
- 可访问性友好（aria 属性）
- 组件 Props 使用 TypeScript 严格类型

参考原项目的设计风格，但需要组件化和可复用。

提示词 5.2 - 编辑器组件迁移
为 documind-pro 项目迁移和重构编辑器组件。

参考原项目：/home/user/documind-ai-agent/components/Editor.tsx

这是一个 1800+ 行的大组件，需要拆分为：

components/features/editor/
├── index.tsx              # 主编辑器组件
├── Toolbar.tsx            # 工具栏
├── BlockMenu.tsx          # 块级菜单
├── ImageHandler.tsx       # 图片处理
├── TableHandler.tsx       # 表格处理
├── OutlinePanel.tsx       # 文档大纲
├── FormatBrush.tsx        # 格式刷
└── hooks/
    ├── useEditorState.ts  # 编辑器状态
    ├── useHistory.ts      # Undo/Redo
    └── useSelection.ts    # 选区管理

迁移要求：
1. 保持原有功能完整
2. 拆分为更小的模块
3. 使用 Zustand 管理编辑器状态
4. 添加 DOMPurify 进行 XSS 防护
5. 优化性能（减少不必要的重渲染）

先分析原项目 Editor.tsx 的功能结构，再进行拆分迁移。

提示词 5.3 - AI 助手组件迁移
为 documind-pro 项目迁移和重构 AI 助手组件。

参考原项目：/home/user/documind-ai-agent/components/FloatingAgent.tsx

这是一个 2000+ 行的大组件，需要拆分为：

components/features/ai-assistant/
├── index.tsx              # 主容器
├── ChatPanel.tsx          # 聊天面板
├── MessageList.tsx        # 消息列表
├── MessageItem.tsx        # 单条消息
├── InputArea.tsx          # 输入区域
├── SkillSelector.tsx      # Skill 选择器（新增）
├── ImagePreview.tsx       # 图片预览
├── ModelSwitcher.tsx      # 模型切换
├── SettingsPanel.tsx      # 设置面板
└── hooks/
    ├── useChat.ts         # 聊天逻辑
    ├── useSkills.ts       # Skills 调用
    └── useStreaming.ts    # 流式响应

关键改进：
1. API 调用改为通过后端代理
2. 集成 Skills 系统
3. 移除前端的 API Key 存储逻辑
4. 添加 Skill 自动选择功能

迁移时需要将原有的直接 API 调用改为调用后端 /api/ai/* 接口。

提示词 5.4 - 其他组件迁移
为 documind-pro 项目迁移剩余组件。

参考原项目 components/ 目录：

1. VisualPanel.tsx → components/features/visualization/
   ├── index.tsx
   ├── ChartView.tsx
   ├── MindmapView.tsx
   └── ExportTools.tsx

2. KnowledgeBase.tsx → components/features/knowledge-base/
   ├── index.tsx
   ├── SourceList.tsx
   ├── SourceItem.tsx
   └── ImportDialog.tsx

3. ImageEditor.tsx → components/features/image-editor/
   ├── index.tsx
   ├── CropTool.tsx
   ├── TransparencyTool.tsx
   └── RemoveBackground.tsx

4. SelectionToolbar.tsx → components/features/editor/SelectionToolbar.tsx

5. DrawingCanvas.tsx → components/features/drawing/

迁移要求：
1. 保持功能完整
2. 适当拆分
3. 统一使用新的类型系统
4. API 调用走后端代理

阶段 6：安全性增强
提示词 6.1 - 认证系统
为 documind-pro 项目实现认证系统。

使用 NextAuth.js 实现：

1. app/api/auth/[...nextauth]/route.ts
   - 配置认证提供商
   - 支持 GitHub OAuth
   - 支持邮箱密码登录
   - 支持 Google OAuth（可选）

2. lib/auth/config.ts
   - NextAuth 配置
   - Session 策略
   - Callbacks

3. lib/auth/session.ts
   - 服务端获取 session 的工具函数
   - 权限检查工具

4. components/auth/
   ├── LoginForm.tsx
   ├── RegisterForm.tsx
   ├── UserMenu.tsx
   └── AuthGuard.tsx

5. app/(auth)/
   ├── login/page.tsx
   ├── register/page.tsx
   └── layout.tsx

6. middleware.ts
   - 保护需要认证的路由
   - /dashboard/* 需要登录
   - /api/* 部分需要登录

数据库使用 Supabase，需要创建 users 表。

提示词 6.2 - XSS 和安全防护
为 documind-pro 项目实现全面的安全防护。

1. lib/security/sanitize.ts
   - 封装 DOMPurify
   - 定义不同场景的过滤规则
   - 编辑器内容、聊天消息、用户输入等

2. lib/security/csp.ts
   - Content Security Policy 配置
   - 在 next.config.js 中应用

3. lib/security/rateLimit.ts
   - API 速率限制
   - 基于 IP 和用户的限制

4. 更新 next.config.js
   - 安全 Headers
   - CSP 策略
   - XSS 保护头

5. 审计所有使用 dangerouslySetInnerHTML 的地方
   - 确保都经过 sanitize 处理

6. lib/security/validation.ts
   - 使用 Zod 的验证 schemas
   - 用户输入验证
   - API 请求验证

确保所有用户可控的内容都经过适当过滤。

阶段 7：存储层 & 用户系统
提示词 7.1 - Supabase 数据库设计
为 documind-pro 项目设计 Supabase 数据库结构。

创建以下表结构（SQL 迁移文件）：

1. supabase/migrations/001_users.sql
   - users 表扩展（NextAuth 基础上）
   - 订阅等级
   - 使用配额

2. supabase/migrations/002_documents.sql
   - documents 表
   - 支持版本控制
   - 支持协作者

3. supabase/migrations/003_usage.sql
   - usage_logs 表
   - 记录 AI 调用次数
   - 用于配额计算

4. supabase/migrations/004_knowledge_sources.sql
   - knowledge_sources 表
   - 用户的资料库

5. 配置 Row Level Security (RLS)
   - 用户只能访问自己的数据
   - 协作者可访问共享文档

6. lib/supabase/client.ts
   - 客户端 Supabase 实例

7. lib/supabase/server.ts
   - 服务端 Supabase 实例
   - 使用 Service Role Key

提供 SQL 文件和 TypeScript 类型。

提示词 7.2 - 用量计费系统
为 documind-pro 项目实现用量计费系统。

1. services/quota/index.ts
   - 配额检查
   - 使用量记录
   - 配额刷新（月度）

2. types/subscription.ts
   - 订阅等级定义
   - Free: 100 次/月 AI 调用
   - Pro: 1000 次/月
   - Enterprise: 无限制

3. app/api/user/quota/route.ts
   - 获取当前配额
   - 获取使用记录

4. components/features/quota/
   ├── QuotaDisplay.tsx    # 配额显示
   └── UsageChart.tsx      # 使用量图表

5. hooks/useQuota.ts
   - 获取配额状态
   - 检查是否超限

6. 在 AI API 中集成配额检查
   - 调用前检查配额
   - 调用后记录使用

暂不实现支付集成，先做使用量追踪。

阶段 8：协同编辑基础
提示词 8.1 - 协同编辑架构
为 documind-pro 项目设计协同编辑的基础架构。

注意：这个阶段只做架构设计和接口定义，不做完整实现。

1. 技术选型分析文档 docs/collaboration-design.md
   - 对比 Yjs vs Automerge vs 自研
   - 推荐方案和理由
   - 架构图

2. types/collaboration.ts
   - 协作者类型
   - 光标位置类型
   - 操作类型
   - 冲突解决类型

3. services/collaboration/interface.ts
   - CollaborationProvider 接口
   - 定义连接、同步、冲突解决方法

4. 预留 API 路由
   - app/api/collaboration/room/route.ts
   - app/api/collaboration/sync/route.ts

5. 预留组件目录
   - components/features/collaboration/
   - Cursors.tsx（显示其他用户光标）
   - PresenceList.tsx（在线用户列表）

6. 数据库预留
   - document_versions 表设计
   - collaboration_sessions 表设计

只做设计和接口定义，实现留到后续迭代。

阶段 9：Skills 实现
提示词 9.1 - 核心 Skills 实现
为 documind-pro 项目实现核心 Skills。

基于之前创建的 Skills 架构，实现以下 Skills：

1. skills/ai-chat/
   - AI 对话 Skill
   - 调用后端 /api/ai/chat
   - 支持流式响应

2. skills/image-generation/
   - AI 图片生成 Skill
   - 调用后端 /api/ai/image
   - 支持不同分辨率

3. skills/visualization/
   - 数据可视化 Skill
   - 生成图表配置
   - 生成思维导图

4. skills/document-analysis/
   - 文档分析 Skill
   - 内容总结
   - 关键点提取

5. skills/web-search/
   - 网络搜索 Skill
   - 调用后端 /api/search

每个 Skill 需要：
- manifest.json（元数据）
- index.ts（Skill 定义和实现）
- 必要的类型定义

参考原项目的相关功能实现：
- geminiService.ts 中的各种 AI 功能
- searchService.ts 中的搜索功能
- VisualPanel.tsx 中的可视化逻辑

将这些功能模块化为独立的 Skills。

阶段 10：集成测试 & 文档
提示词 10.1 - 集成和测试
为 documind-pro 项目进行最终集成和测试。

1. 创建主页面布局
   - app/(dashboard)/page.tsx
   - 三栏布局：知识库 | 编辑器 | AI 助手
   - 参考原项目 App.tsx 的布局

2. 集成所有组件
   - 连接状态管理
   - 连接 API 层
   - 连接 Skills 系统

3. 创建测试文件
   - __tests__/api/ai.test.ts
   - __tests__/skills/registry.test.ts
   - __tests__/components/Editor.test.tsx

4. 配置测试环境
   - jest.config.js
   - 测试工具函数

5. 端到端测试场景
   - 用户登录流程
   - 创建文档
   - AI 对话
   - 图片生成
   - 保存和加载

6. 性能检查
   - 使用 Lighthouse 分析
   - 识别性能瓶颈

确保所有功能正常工作，与原项目功能对等。

提示词 10.2 - 文档和部署
为 documind-pro 项目创建文档和部署配置。

1. README.md
   - 项目介绍
   - 技术栈说明
   - 本地开发指南
   - 环境变量说明

2. docs/
   ├── architecture.md      # 架构设计文档
   ├── skills-guide.md      # Skills 开发指南
   ├── api-reference.md     # API 参考
   └── deployment.md        # 部署指南

3. 部署配置
   - vercel.json（Vercel 部署配置）
   - Dockerfile（可选，容器部署）

4. 环境变量文档
   - .env.example 完善
   - 所有必需和可选的环境变量

5. CHANGELOG.md
   - 版本记录
   - 从原项目到商业版的变更

6. 贡献指南
   - CONTRIBUTING.md
   - 代码规范
   - PR 流程

执行顺序建议
Week 1: 阶段 1-2（项目初始化 + 类型系统 + Skills 架构）
Week 2: 阶段 3（后端 API 层）
Week 3: 阶段 4（核心服务层）
Week 4: 阶段 5（UI 组件迁移）
Week 5: 阶段 6-7（安全 + 存储 + 用户系统）
Week 6: 阶段 8-9（协同编辑基础 + Skills 实现）
Week 7: 阶段 10（集成测试 + 文档）